### ===========================================
### ToDoList API - HTTP Requests
### VARIABLES - DEBEN ESTAR AL INICIO
### ===========================================

@baseUrl = https://localhost:7163
@userId = 1

### ===========================================
### 🔐 AUTENTICACIÓN
### ===========================================

### 1. Login - Obtener Token JWT
POST {{baseUrl}}/api/Auth/Login
Content-Type: application/json

{
  "username": "jordansep",
  "password": "123456789"
}

###

> {%
  client.global.set("token", response.body);
  console.log("✅ Token guardado correctamente");
  console.log("Token (primeros 50 chars):", response.body.substring(0, 50) + "...");
%}

### ===========================================
### 👥 USUARIOS - Endpoints Públicos
### ===========================================

### 2. Register - Crear nuevo usuario (Sin autenticación)
POST {{baseUrl}}/api/Users/Register
Content-Type: application/json

{
  "username": "testuser2",
  "email": "testuser2@example.com",
  "password": "SecurePass123!",
  "name": "Test",
  "lastName": "User"
}

### ===========================================
### 👥 USUARIOS - Endpoints Protegidos
### ===========================================

### 3. Search User - Buscar usuario (Admin/Manager only)
GET {{baseUrl}}/api/Users/SearchUser?username=jordansep
Authorization: Bearer {{token}}

### 4. Update User - Actualizar usuario (Owner o Admin)
PUT {{baseUrl}}/api/Users/UpdateUser/{{userId}}
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "super",
  "name": "Super",
  "lastName": "User"
}

### 5. Delete User - Eliminar usuario (Owner o Admin)
# ⚠️ CUIDADO: Esta acción elimina el usuario permanentemente
DELETE {{baseUrl}}/api/Users/DeleteUser/{{userId}}
Authorization: Bearer {{token}}

### ===========================================
### 🧪 PRUEBAS DE AUTORIZACIÓN
### ===========================================

### 6. Test: Intentar actualizar SIN token (debe dar 401)
# Esta petición NO tiene Authorization header
PUT https://localhost:7163/api/Users/UpdateUser/1
Content-Type: application/json

{
  "username": "should_fail",
  "name": "Test",
  "lastName": "Fail"
}

###

> {%
  client.test("Debe devolver 401 Unauthorized", function() {
    client.assert(response.status === 401, "Expected 401 but got " + response.status);
  });
  console.log("✅ Test #6: Verificado que sin token devuelve 401");
%}

### 7. Test: Intentar actualizar OTRO usuario (debe dar 401 si no eres Admin)
# Esta petición tiene token pero intenta actualizar otro usuario
PUT https://localhost:7163/api/Users/UpdateUser/999
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "should_fail_if_not_admin",
  "name": "Test",
  "lastName": "Fail"
}

###

> {%
  client.test("Debe devolver 401 o 404", function() {
    var validStatuses = [401, 404];
    var isValid = validStatuses.includes(response.status);
    client.assert(isValid, "Expected 401 or 404 but got " + response.status);
  });
  console.log("✅ Test #7: Verificado que no puedes actualizar otros usuarios");
%}

### ===========================================
### 🔍 DEBUG Y UTILIDADES
### ===========================================

### 8. Ver Token Actual
GET {{baseUrl}}/api/Users/SearchUser?username=jordansep
Authorization: Bearer {{token}}

###

> {%
  var savedToken = client.global.get("token");
  if (savedToken) {
    console.log("Token actual (primeros 50 chars):", savedToken.substring(0, 50) + "...");
  } else {
    console.log("❌ No hay token guardado. Ejecuta el login primero.");
  }
%}

### 9. Verificar Claims del Token
GET {{baseUrl}}/api/Users/SearchUser?username=jordansep
Authorization: Bearer {{token}}

###

> {%
  var token = client.global.get("token");
  if (token) {
    try {
      var parts = token.split('.');
      if (parts.length === 3) {
        var payload = JSON.parse(atob(parts[1]));
        console.log("=== CLAIMS DEL TOKEN ===");
        console.log("ID Usuario (nameid):", payload.nameid);
        console.log("Email:", payload.email);
        console.log("Role:", payload.role);
        console.log("Expira:", new Date(payload.exp * 1000).toLocaleString());
        console.log("========================");
      }
    } catch (e) {
      console.log("❌ Error al decodificar token:", e);
    }
  } else {
    console.log("❌ No hay token. Ejecuta el login primero.");
  }
%}

### ===========================================
### 🎯 EJEMPLOS ESPECÍFICOS - ADMIN
### ===========================================

### 10. Crear un usuario Admin
POST {{baseUrl}}/api/Users/Register
Content-Type: application/json

{
  "username": "admin",
  "email": "admin@example.com",
  "password": "AdminPass123!",
  "name": "Admin",
  "lastName": "User",
  "role": 2
}

### 11. Login como Admin
POST {{baseUrl}}/api/Auth/Login
Content-Type: application/json

{
  "username": "admin@example.com",
  "password": "AdminPass123!"
}

###

> {%
  client.global.set("adminToken", response.body);
  console.log("✅ Token de Admin guardado");
  console.log("Admin Token (primeros 50 chars):", response.body.substring(0, 50) + "...");
%}

### 12. Admin actualiza cualquier usuario
PUT {{baseUrl}}/api/Users/UpdateUser/1
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "username": "updated_by_admin",
  "name": "Admin",
  "lastName": "Updated"
}

###

> {%
  client.test("Admin puede actualizar cualquier usuario", function() {
    client.assert(response.status === 200, "Expected 200 but got " + response.status);
  });
  if (response.status === 200) {
    console.log("✅ Test #12: Admin actualizó usuario exitosamente");
  }
%}

### ===========================================
### 📝 FLUJO COMPLETO DE TESTING
### ===========================================

### 13. Test Suite Completa - Ejecuta en orden
# Ejecuta estas peticiones en secuencia para probar toda la API

### a) Login como usuario normal
POST {{baseUrl}}/api/Auth/Login
Content-Type: application/json

{
  "username": "jordansep",
  "password": "123456789"
}

###

> {%
  client.global.set("token", response.body);
  console.log("1️⃣ Login exitoso");
%}

### b) Actualizar tu propio usuario (debe funcionar)
PUT {{baseUrl}}/api/Users/UpdateUser/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "jordansep",
  "name": "Jordan",
  "lastName": "Sep"
}

###

> {%
  client.test("Usuario normal puede actualizar su propio perfil", function() {
    client.assert(response.status === 200, "Expected 200 but got " + response.status);
  });
  if (response.status === 200) {
    console.log("2️⃣ Usuario actualizó su propio perfil");
  }
%}

### c) Intentar actualizar otro usuario (debe fallar)
PUT {{baseUrl}}/api/Users/UpdateUser/2
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "username": "should_fail",
  "name": "Fail",
  "lastName": "Test"
}

###

> {%
  client.test("Usuario normal NO puede actualizar otros usuarios", function() {
    client.assert(response.status === 401 || response.status === 404, 
      "Expected 401 or 404 but got " + response.status);
  });
  console.log("3️⃣ Verificado: No puedes actualizar otros usuarios");
%}

### ===========================================
### 📝 NOTAS DE USO
### ===========================================

# GUÍA RÁPIDA:
# 
# 1. PRIMEROS PASOS:
#    - Ejecuta #1 (Login) para obtener el token
#    - El token se guarda automáticamente
#
# 2. PRUEBAS BÁSICAS:
#    - #4: Actualiza tu usuario (debe funcionar)
#    - #6: Intenta sin token (debe fallar con 401)
#    - #7: Intenta actualizar otro usuario (debe fallar)
#
# 3. PRUEBAS ADMIN:
#    - #10: Crea un usuario admin
#    - #11: Login como admin
#    - #12: Admin actualiza cualquier usuario
#
# 4. DEBUG:
#    - #8: Ver token guardado
#    - #9: Ver claims del token (ID, email, role)
#
# 5. TEST SUITE:
#    - #13: Ejecuta la suite completa (a, b, c en orden)